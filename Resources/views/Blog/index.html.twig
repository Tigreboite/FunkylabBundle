{% extends 'TigreboiteFunkylabBundle::layout.html.twig' %}

{% block action %}
     <a class="btn btn-default btn-lg" href="#" data-toggle="modal" data-url="{{ path('admin_blog_new') }}">
        <i class="fa fa-plus"></i> Add blog
    </a>
{% endblock %}

{% block content -%}

    <div class="box-body table-responsive no-padding">

        <table id="table_admin" class="table table-striped table-bordered table-hover">
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Title</th>
                    <th>Type</th>
                    <th>Nb Comments</th>
                    <th>Language</th>
                    <th>Statut</th>
                    <th class="action"></th>
                </tr>
            </thead>

        </table>
    </div>

{% endblock %}

{% block js %}
<script>
    $('document').ready(function()
    {
        var actionHtml = '<div class="btn-group"> \
                      <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false"> \
                        Action <span class="caret"></span> \
                      </button> \
                      <ul class="dropdown-menu" role="menu"> \
                        <li id="additionnal-btn"></li> \
                        <li><a class="btn-edit" href="#" data-toggle="modal" data-url=""><i class="fa fa-edit"></i> Edit</a></li> \
                        <li><a class="btn-delete-action" href="#"><i class="fa fa-times-circle"></i> Delete</a></li> \
                      </ul> \
                    </div> \
        ';

        table = $('#table_admin').DataTable( {
            "processing": true,
            "serverSide": true,
            "ajax": Routing.generate('admin_blog_list'),
            "aoColumns": [
                { "sName": "id" },
                { "sName": "title" },
                { "sName": "type.name" },
                { "sName": "nbcomment" },
                { "sName": "language.code" },
                { "sName": "status" },
                { "sName": "_action" }
            ],
            "columnDefs": [ {
                "targets": -1,
                "data": null,
                'bSortable': false, 'aTargets': [ 1 ],
                "defaultContent": actionHtml
            }],
            "oLanguage": {
                "sProcessing": "<img src='/bundles/tigreboitefunkylab/images/ajax-loader.gif'>"
            },
            "fnDrawCallback": function( oSettings ) {
              updateModalBtn();
            },
            "fnCreatedRow": function( nRow, aData, iDataIndex ) {
                var url_update = Routing.generate('admin_blog_edit', {id:aData[aData.length-1]});
                $(nRow).find('td:last .btn-edit').attr('data-url', url_update);

                num_col_status = 4;
                num_col_nbcomment = 3;

                if(aData[num_col_status] == '') {
                    $('td:eq('+num_col_status+')', nRow).html( 'Dépublié' );
                } else if (aData[num_col_status] == 1) {
                    $('td:eq('+num_col_status+')', nRow).html( 'Publié' );
                } else if (aData[num_col_status] == 2) {
                    $('td:eq('+num_col_status+')', nRow).html( 'Archivé' );
                }

                if(aData[num_col_nbcomment] == "") aData[num_col_nbcomment] = "0";

                url_comment_list = Routing.generate('admin_blogcomment', { 'blog_id' : aData[0]});
                $('td:eq('+num_col_nbcomment+')', nRow).html( '<a href="'+ url_comment_list +'">'+aData[num_col_nbcomment]+' Comments</a>' );

                new_btn_action = '<a href="'+Routing.generate('admin_blog_redirection_front', {id:aData[0]})+'" target="blank"><i class="fa fa-eye"></i> Show</a>'

                if(new_btn_action == "") $(nRow).find('#additionnal-btn').remove()
                else $(nRow).find('#additionnal-btn').html(new_btn_action)
            }
        });

        // Remove btn
        $('#table_admin tbody').on( 'click', '.btn-delete-action', function (e) {
            e.preventDefault();
            var data = table.row( $(this).parents('tr') ).data();
            var id_line = data[data.length-1];

            $.confirm({
                text: "Are you sure you want to delete ?",
                confirm: function(button) {
                    $.ajax({
                        type: "DELETE",
                        url: Routing.generate('admin_blog_delete', {id:id_line}),
                        success: function(msg){
                            table.draw();
                        }
                    });
                },
                cancel: function(button) {
                    // do something
                }
            });

        });
    });
</script>
{% endblock %}
